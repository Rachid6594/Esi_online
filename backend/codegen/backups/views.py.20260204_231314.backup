from rest_framework.decorators import api_view, permission_classes
from rest_framework.response import Response
from rest_framework import status
from app.administration.services import AnneeAcademiqueService
from app.administration.api.serializers import AnneeAcademiqueSerializer
from app.core.exceptions import NotFoundError
from app.administration.permissions.administration_permissions import (
    CanViewAnneeAcademique, CanCreateAnneeAcademique,
    CanUpdateAnneeAcademique, CanDeleteAnneeAcademique,
)
from app.administration.services import NiveauService
from app.administration.api.serializers import NiveauSerializer
from app.administration.permissions.administration_permissions import (
    CanViewNiveau, CanCreateNiveau,
    CanUpdateNiveau, CanDeleteNiveau,
)

# --- AnneeAcademique (CRUD + permissions) ---
@api_view(["GET", "POST"])
@permission_classes([
    CanViewAnneeAcademique,
    CanCreateAnneeAcademique,
])
def anneeacademique_list(request):
    """GET: liste | POST: création."""
    if request.method == "GET":
        service = AnneeAcademiqueService()
        qs = service.list_all()
        serializer = AnneeAcademiqueSerializer(qs, many=True)
        return Response(serializer.data)
    # POST
    serializer = AnneeAcademiqueSerializer(data=request.data)
    serializer.is_valid(raise_exception=True)
    service = AnneeAcademiqueService()
    obj = service.create(**serializer.validated_data)
    serializer = AnneeAcademiqueSerializer(obj)
    return Response(serializer.data, status=status.HTTP_201_CREATED)


@api_view(["GET", "PUT", "PATCH", "DELETE"])
@permission_classes([
    CanViewAnneeAcademique,
    CanUpdateAnneeAcademique,
    CanDeleteAnneeAcademique,
])
def anneeacademique_detail(request, pk: int):
    """GET: détail | PUT/PATCH: modification | DELETE: suppression."""
    service = AnneeAcademiqueService()
    try:
        obj = service.get_or_raise(pk)
    except NotFoundError as e:
        return Response({"detail": str(e.message)}, status=status.HTTP_404_NOT_FOUND)
    if request.method == "GET":
        serializer = AnneeAcademiqueSerializer(obj)
        return Response(serializer.data)
    if request.method == "DELETE":
        service.delete(pk)
        return Response(status=status.HTTP_204_NO_CONTENT)
    # PUT / PATCH
    partial = request.method == "PATCH"
    serializer = AnneeAcademiqueSerializer(obj, data=request.data, partial=partial)
    serializer.is_valid(raise_exception=True)
    updated = service.update(pk, **serializer.validated_data)
    return Response(AnneeAcademiqueSerializer(updated).data)

# --- Niveau (CRUD + permissions) ---
@api_view(["GET", "POST"])
@permission_classes([
    CanViewNiveau,
    CanCreateNiveau,
])
def niveau_list(request):
    """GET: liste | POST: création."""
    if request.method == "GET":
        service = NiveauService()
        qs = service.list_all()
        serializer = NiveauSerializer(qs, many=True)
        return Response(serializer.data)
    # POST
    serializer = NiveauSerializer(data=request.data)
    serializer.is_valid(raise_exception=True)
    service = NiveauService()
    obj = service.create(**serializer.validated_data)
    serializer = NiveauSerializer(obj)
    return Response(serializer.data, status=status.HTTP_201_CREATED)


@api_view(["GET", "PUT", "PATCH", "DELETE"])
@permission_classes([
    CanViewNiveau,
    CanUpdateNiveau,
    CanDeleteNiveau,
])
def niveau_detail(request, pk: int):
    """GET: détail | PUT/PATCH: modification | DELETE: suppression."""
    service = NiveauService()
    try:
        obj = service.get_or_raise(pk)
    except NotFoundError as e:
        return Response({"detail": str(e.message)}, status=status.HTTP_404_NOT_FOUND)
    if request.method == "GET":
        serializer = NiveauSerializer(obj)
        return Response(serializer.data)
    if request.method == "DELETE":
        service.delete(pk)
        return Response(status=status.HTTP_204_NO_CONTENT)
    # PUT / PATCH
    partial = request.method == "PATCH"
    serializer = NiveauSerializer(obj, data=request.data, partial=partial)
    serializer.is_valid(raise_exception=True)
    updated = service.update(pk, **serializer.validated_data)
    return Response(NiveauSerializer(updated).data)

