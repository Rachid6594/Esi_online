"""
Modèles pour l'application administration.
"""
from django.db import models
from django.utils import timezone


class Administration(models.Model):
    """Modèle Administration."""
    name = models.CharField(max_length=255, verbose_name="Nom")
    description = models.TextField(blank=True, null=True, verbose_name="Description")
    created_at = models.DateTimeField(default=timezone.now, verbose_name="Date de création")
    updated_at = models.DateTimeField(auto_now=True, verbose_name="Date de modification")

    class Meta:
        verbose_name = "Administration"
        verbose_name_plural = "Administration"
        ordering = ["-created_at"]

    def __str__(self):
        return self.name


class AnneeAcademique(models.Model):
    """AnneeAcademique."""

    libelle = models.CharField(max_length=50)
    date_debut = models.DateField()
    date_fin = models.DateField()
    is_active = models.BooleanField(default=False)
    created_by = models.ForeignKey(null=True, to='admin.User', on_delete=models.SET_NULL, related_name='annees_creees')
    updated_by = models.ForeignKey(null=True, to='admin.User', on_delete=models.SET_NULL, related_name='annees_modifiees')

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        db_table = 'annees_academiques'
        verbose_name = 'Année académique'
        verbose_name_plural = 'Années académiques'
        ordering = ['-created_at']

    def __str__(self):
        return str(self.title if hasattr(self, 'title') else self.id)


class Niveau(models.Model):
    """Niveau."""

    code = models.CharField(max_length=2)
    libelle = models.CharField(max_length=100)
    ordre = models.IntegerField(default=0)

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        db_table = 'niveaux'
        verbose_name = 'Niveau'
        verbose_name_plural = 'Niveaux'
        ordering = ['-created_at']

    def __str__(self):
        return str(self.title if hasattr(self, 'title') else self.id)


class Filiere(models.Model):
    """Filiere."""

    code = models.CharField(max_length=10)
    libelle = models.CharField(max_length=200)
    description = models.TextField(null=True, blank=True)

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        db_table = 'filieres'
        verbose_name = 'Filière'
        verbose_name_plural = 'Filières'
        ordering = ['-created_at']

    def __str__(self):
        return str(self.title if hasattr(self, 'title') else self.id)


class Classe(models.Model):
    """Classe."""

    code = models.CharField(max_length=20)
    libelle = models.CharField(max_length=200)
    niveau = models.ForeignKey(to='administration.Niveau', on_delete=models.CASCADE, related_name='classes')
    filiere = models.ForeignKey(to='administration.Filiere', on_delete=models.CASCADE, related_name='classes')
    annee_academique = models.ForeignKey(to='administration.AnneeAcademique', on_delete=models.CASCADE, related_name='classes')
    effectif_max = models.IntegerField(default=50)
    created_by = models.ForeignKey(null=True, to='admin.User', on_delete=models.SET_NULL, related_name='classes_creees')

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        db_table = 'classes'
        verbose_name = 'Classe'
        verbose_name_plural = 'Classes'
        ordering = ['-created_at']

    def __str__(self):
        return str(self.title if hasattr(self, 'title') else self.id)


class Matiere(models.Model):
    """Matiere."""

    code = models.CharField(max_length=20)
    libelle = models.CharField(max_length=200)
    description = models.TextField(null=True, blank=True)
    type_matiere = models.CharField(max_length=10, default='COURS')
    coefficient = models.DecimalField(max_digits=4, decimal_places=2, default=1.0)
    credit = models.IntegerField(default=3)
    niveau = models.ForeignKey(to='administration.Niveau', on_delete=models.CASCADE, related_name='matieres')
    filiere = models.ForeignKey(null=True, blank=True, to='administration.Filiere', on_delete=models.CASCADE, related_name='matieres')
    semestre = models.IntegerField()

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        db_table = 'matieres'
        verbose_name = 'Matière'
        verbose_name_plural = 'Matières'
        ordering = ['-created_at']

    def __str__(self):
        return str(self.title if hasattr(self, 'title') else self.id)


class AdministrationEcole(models.Model):
    """AdministrationEcole."""

    user = models.OneToOneField(to='admin.User', on_delete=models.CASCADE, related_name='admin_ecole_profile')
    matricule = models.CharField(max_length=20)
    poste = models.CharField(max_length=30)
    departement = models.CharField(max_length=200, null=True, blank=True)
    bureau = models.CharField(max_length=50, null=True, blank=True)
    peut_gerer_etudiants = models.BooleanField(default=True)
    peut_gerer_enseignants = models.BooleanField(default=False)
    peut_gerer_structure_academique = models.BooleanField(default=False)
    peut_envoyer_annonces = models.BooleanField(default=True)
    peut_gerer_bibliotheque = models.BooleanField(default=False)
    peut_voir_statistiques = models.BooleanField(default=True)

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        db_table = 'administration_ecole'
        verbose_name = 'Administration École'
        verbose_name_plural = 'Administration École'
        ordering = ['-created_at']

    def __str__(self):
        return str(self.title if hasattr(self, 'title') else self.id)


class Annonce(models.Model):
    """Annonce."""

    titre = models.CharField(max_length=300)
    contenu = models.TextField()
    categorie = models.CharField(max_length=20, default='INFORMATION')
    fichier_joint = models.CharField(max_length=500, null=True, blank=True)
    destinataires_tous = models.BooleanField(default=False)
    destinataires_roles = models.CharField(max_length=200, null=True, blank=True)
    statut = models.CharField(max_length=15, default='BROUILLON')
    date_publication = models.DateTimeField(null=True, blank=True)
    date_expiration = models.DateTimeField(null=True, blank=True)
    auteur = models.ForeignKey(to='admin.User', on_delete=models.CASCADE, related_name='annonces_creees')
    envoi_email = models.BooleanField(default=True)
    envoi_notification = models.BooleanField(default=True)
    affichage_tableau = models.BooleanField(default=True)

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        db_table = 'annonces'
        verbose_name = 'Annonce'
        verbose_name_plural = 'Annonces'
        ordering = ['-created_at']

    def __str__(self):
        return str(self.title if hasattr(self, 'title') else self.id)


class LectureAnnonce(models.Model):
    """LectureAnnonce."""

    annonce = models.ForeignKey(to='administration.Annonce', on_delete=models.CASCADE, related_name='lectures')
    user = models.ForeignKey(to='admin.User', on_delete=models.CASCADE, related_name='annonces_lues')

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        db_table = 'lectures_annonces'
        verbose_name = 'Lecture Annonce'
        verbose_name_plural = 'Lectures Annonces'
        ordering = ['-created_at']

    def __str__(self):
        return str(self.title if hasattr(self, 'title') else self.id)


class EmploiDuTemps(models.Model):
    """EmploiDuTemps."""

    classe = models.ForeignKey(to='administration.Classe', on_delete=models.CASCADE, related_name='emplois_du_temps')
    matiere = models.ForeignKey(to='administration.Matiere', on_delete=models.CASCADE, related_name='emplois_du_temps')
    enseignant = models.ForeignKey(null=True, to='espace_prof.Enseignant', on_delete=models.SET_NULL, related_name='emplois_du_temps')
    annee_academique = models.ForeignKey(to='administration.AnneeAcademique', on_delete=models.CASCADE, related_name='emplois_du_temps')
    jour = models.CharField(max_length=10)
    heure_debut = models.TimeField()
    heure_fin = models.TimeField()
    salle = models.CharField(max_length=50, null=True, blank=True)
    type_seance = models.CharField(max_length=10, default='COURS')
    date_debut_validite = models.DateField(null=True, blank=True)
    date_fin_validite = models.DateField(null=True, blank=True)
    created_by = models.ForeignKey(null=True, to='admin.User', on_delete=models.SET_NULL, related_name='edt_crees')

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        db_table = 'emplois_du_temps'
        verbose_name = 'Emploi du Temps'
        verbose_name_plural = 'Emplois du Temps'
        ordering = ['-created_at']

    def __str__(self):
        return str(self.title if hasattr(self, 'title') else self.id)
